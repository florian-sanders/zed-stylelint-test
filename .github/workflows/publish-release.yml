name: Publish Release

on:
  push:
    branches: [main]

permissions:
  contents: write

concurrency:
  group: publish-release
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse Extension Version
        id: version
        run: |
          EXT_VERSION=$(grep "^version = " extension.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "ext_version=$EXT_VERSION" >> $GITHUB_OUTPUT
          echo "Extension version: $EXT_VERSION"

      - name: Parse LSP Version
        id: lsp
        run: |
          LSP_VERSION=$(grep "lsp_required_version" extension.toml | sed 's/.*"\(.*\)".*/\1/')
          echo "lsp_version=$LSP_VERSION" >> $GITHUB_OUTPUT
          echo "LSP version: $LSP_VERSION"

      - name: Find Prerelease
        id: find-prerelease
        uses: actions/github-script@v7
        with:
          script: |
            const extVersion = '${{ steps.version.outputs.ext_version }}';

            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            // Look for a prerelease or draft matching the extension version
            const release = releases.find(r => {
              return (r.prerelease || r.draft) && r.tag_name === extVersion;
            });

            if (!release) {
              console.log(`No prerelease/draft found for v${extVersion}`);
              return null;
            }

            console.log(`Found ${release.prerelease ? 'prerelease' : 'draft'}: ${release.html_url}`);
            return {
              id: release.id,
              tag: release.tag_name,
              prerelease: release.prerelease,
              draft: release.draft
            };

      # ── Path A: Prerelease found → build WASM, upload, promote ──

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable --target wasm32-wasip1
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          source "$HOME/.cargo/env"
          rustc --version
          cargo --version

      - name: Build Extension
        run: |
          cargo build --release --target wasm32-wasip1
          cp target/wasm32-wasip1/release/zed_stylelint.wasm extension.wasm
          echo "Built extension.wasm"

      - name: Promote Prerelease
        if: steps.find-prerelease.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const releaseInfo = ${{ steps.find-prerelease.outputs.result }};
            const extVersion = '${{ steps.version.outputs.ext_version }}';

            // Read changelog for this version
            let releaseBody = '';
            const changelogPath = 'CHANGELOG.md';
            if (fs.existsSync(changelogPath)) {
              const changelog = fs.readFileSync(changelogPath, 'utf8');
              const versionMatch = changelog.match(
                new RegExp(`## \\[?v?${extVersion}\\]?.*?(?=\\n## \\[|$)`, 's')
              );
              if (versionMatch) {
                releaseBody = versionMatch[0].trim();
              }
            }

            // Upload extension.wasm to the existing release
            const wasmData = fs.readFileSync('extension.wasm');
            console.log(`Uploading extension.wasm (${wasmData.length} bytes)...`);

            // Delete existing extension.wasm asset if present
            const { data: release } = await github.rest.repos.getRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: releaseInfo.id
            });

            const existingWasm = release.assets.find(a => a.name === 'extension.wasm');
            if (existingWasm) {
              await github.rest.repos.deleteReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                asset_id: existingWasm.id
              });
              console.log('Deleted existing extension.wasm asset');
            }

            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: releaseInfo.id,
              name: 'extension.wasm',
              data: wasmData,
              headers: {
                'content-type': 'application/wasm',
                'content-length': wasmData.length
              }
            });
            console.log('Uploaded extension.wasm');

            // Promote: set draft=false, prerelease=false
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: releaseInfo.id,
              tag_name: extVersion,
              name: `v${extVersion}`,
              body: releaseBody || `Release v${extVersion}`,
              draft: false,
              prerelease: false
            });

            console.log(`✅ Promoted release v${extVersion}`);

      # ── Path B: No prerelease → build everything from scratch ──

      - name: Setup Node.js
        if: steps.find-prerelease.outputs.result == 'null'
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Build LSP
        if: steps.find-prerelease.outputs.result == 'null'
        uses: ./.github/actions/build-lsp
        with:
          version: ${{ steps.lsp.outputs.lsp_version }}

      - name: Create Release with Assets
        if: steps.find-prerelease.outputs.result == 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const crypto = require('crypto');
            const { execSync } = require('child_process');
            const extVersion = '${{ steps.version.outputs.ext_version }}';
            const lspVersion = '${{ steps.lsp.outputs.lsp_version }}';

            // Read changelog
            let releaseBody = '';
            const changelogPath = 'CHANGELOG.md';
            if (fs.existsSync(changelogPath)) {
              const changelog = fs.readFileSync(changelogPath, 'utf8');
              const versionMatch = changelog.match(
                new RegExp(`## \\[?v?${extVersion}\\]?.*?(?=\\n## \\[|$)`, 's')
              );
              if (versionMatch) {
                releaseBody = versionMatch[0].trim();
              }
            }

            // Create tarball from lsp/ directory
            const tarballName = `stylelint-language-server-v${lspVersion}.tar.gz`;
            const sha256Name = `stylelint-language-server-v${lspVersion}.sha256`;

            // Verify lsp/ exists (build-lsp should have created it)
            if (!fs.existsSync('lsp')) {
              throw new Error('lsp/ directory not found after build-lsp action');
            }

            execSync(`tar -czf "${tarballName}" lsp/`);
            console.log(`Created ${tarballName}`);

            // Calculate SHA256
            const tarData = fs.readFileSync(tarballName);
            const sha256 = crypto.createHash('sha256').update(tarData).digest('hex');
            fs.writeFileSync(sha256Name, `${sha256}  ${tarballName}\n`);
            console.log(`SHA256: ${sha256}`);

            // Create release
            const { data: release } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: extVersion,
              name: `v${extVersion}`,
              body: releaseBody || `Release v${extVersion}`,
              draft: false,
              prerelease: false
            });

            console.log(`Created release v${extVersion}: ${release.html_url}`);

            // Upload extension.wasm
            const wasmData = fs.readFileSync('extension.wasm');
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
              name: 'extension.wasm',
              data: wasmData,
              headers: {
                'content-type': 'application/wasm',
                'content-length': wasmData.length
              }
            });
            console.log('Uploaded extension.wasm');

            // Upload LSP tarball
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
              name: tarballName,
              data: tarData,
              headers: {
                'content-type': 'application/gzip',
                'content-length': tarData.length
              }
            });
            console.log(`Uploaded ${tarballName}`);

            // Upload SHA256
            const sha256Data = fs.readFileSync(sha256Name, 'utf-8');
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
              name: sha256Name,
              data: sha256Data,
              headers: {
                'content-type': 'text/plain',
                'content-length': Buffer.byteLength(sha256Data)
              }
            });
            console.log(`Uploaded ${sha256Name}`);

            console.log(`✅ Release v${extVersion} complete with LSP v${lspVersion}`);

      - name: Cleanup
        if: always()
        run: |
          rm -f extension.wasm
          rm -f stylelint-language-server-*.tar.gz
          rm -f stylelint-language-server-*.sha256
          echo "Cleaned up build artifacts"
