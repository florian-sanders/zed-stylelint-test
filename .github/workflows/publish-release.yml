name: Publish Release

on:
  push:
    branches: [main]

permissions:
  contents: write

concurrency:
  group: publish-release
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse Extension Version
        id: version
        run: |
          EXT_VERSION=$(grep "^version = " extension.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "ext_version=$EXT_VERSION" >> $GITHUB_OUTPUT
          echo "Extension version: $EXT_VERSION"

      - name: Parse LSP Version
        id: lsp
        run: |
          LSP_VERSION=$(grep "lsp_required_version" extension.toml | sed 's/.*"\(.*\)".*/\1/')
          echo "lsp_version=$LSP_VERSION" >> $GITHUB_OUTPUT
          echo "LSP version: $LSP_VERSION"

      - name: Find Prerelease
        id: find-prerelease
        uses: actions/github-script@v7
        with:
          script: |
            const extVersion = '${{ steps.version.outputs.ext_version }}';

            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            // Look for a prerelease or draft matching the extension version
            const release = releases.find(r => {
              return (r.prerelease || r.draft) && r.tag_name === extVersion;
            });

            if (!release) {
              console.log(`No prerelease/draft found for v${extVersion}`);
              return null;
            }

            console.log(`Found ${release.prerelease ? 'prerelease' : 'draft'}: ${release.html_url}`);
            return {
              id: release.id,
              tag: release.tag_name,
              prerelease: release.prerelease,
              draft: release.draft
            };

      # ── Path A: Prerelease found → build WASM, upload, promote ──

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable --target wasm32-wasip1
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          source "$HOME/.cargo/env"
          rustc --version
          cargo --version

      - name: Build Extension
        run: |
          cargo build --release --target wasm32-wasip1
          cp target/wasm32-wasip1/release/zed_stylelint.wasm extension.wasm
          echo "Built extension.wasm"

      - name: Get Release Body
        id: release-body
        run: |
          EXT_VERSION='${{ steps.version.outputs.ext_version }}'
          if [ -f CHANGELOG.md ]; then
            BODY=$(awk -v ver="$EXT_VERSION" '/^## \[?v?/ { if (p) exit; p=1; next } p' CHANGELOG.md | head -20)
            echo "body<<EOF" >> $GITHUB_OUTPUT
            echo "$BODY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "body=Release v$EXT_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Promote Prerelease
        if: steps.find-prerelease.outputs.result != 'null'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.ext_version }}
          name: v${{ steps.version.outputs.ext_version }}
          body: ${{ steps.release-body.outputs.body }}
          draft: false
          prerelease: false
          files: extension.wasm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ── Path B: No prerelease → build everything from scratch ──

      - name: Setup Node.js
        if: steps.find-prerelease.outputs.result == 'null'
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Build LSP
        if: steps.find-prerelease.outputs.result == 'null'
        uses: ./.github/actions/build-lsp
        with:
          version: ${{ steps.lsp.outputs.lsp_version }}

      - name: Create Release with Assets
        if: steps.find-prerelease.outputs.result == 'null'
        run: |
          LSP_VERSION='${{ steps.lsp.outputs.lsp_version }}'
          tar -czf "stylelint-language-server-v${LSP_VERSION}.tar.gz" lsp/
          echo "Created stylelint-language-server-v${LSP_VERSION}.tar.gz"

      - name: Create SHA256
        if: steps.find-prerelease.outputs.result == 'null'
        run: |
          LSP_VERSION='${{ steps.lsp.outputs.lsp_version }}'
          sha256sum "stylelint-language-server-v${LSP_VERSION}.tar.gz" > "stylelint-language-server-v${LSP_VERSION}.sha256"

      - name: Release
        if: steps.find-prerelease.outputs.result == 'null'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.ext_version }}
          name: v${{ steps.version.outputs.ext_version }}
          body: ${{ steps.release-body.outputs.body }}
          draft: false
          prerelease: false
          files: |
            stylelint-language-server-${{ steps.lsp.outputs.lsp_version }}.tar.gz
            stylelint-language-server-${{ steps.lsp.outputs.lsp_version }}.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        if: always()
        run: |
          rm -f extension.wasm
          rm -f stylelint-language-server-*.tar.gz
          rm -f stylelint-language-server-*.sha256
          echo "Cleaned up build artifacts"
